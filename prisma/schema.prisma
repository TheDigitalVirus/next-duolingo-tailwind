// schema.prisma atualizado para suportar múltiplos cursos
generator client {
  provider   = "prisma-client-js"
  engineType = "client"
}

datasource db {
  provider  = "postgresql"
}

// Enums (mantidos)
enum ChallengeType {
  SELECT
  ASSIST
  CODE
  FILL_BLANK
  REORDER
  MATCH
}

enum DifficultyLevel {
  EASY
  MEDIUM
  HARD
  EXPERT
}

enum SubscriptionTier {
  FREE
  PRO
}

enum Intensity { 
  CASUAL 
  REGULAR 
  INTENSE 
  HARD 
}

enum Focus { 
  GENERAL 
  ACADEMIC 
  TRAVEL 
  BUSINESS 
  CONVERSATION 
  FUN 
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum CourseCategory {
  LANGUAGE
  PROGRAMMING
}

enum CourseLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

enum EnrollmentStatus {
  ACTIVE
  COMPLETED
  PAUSED
  ABANDONED
}

// Models
model User {
  id               String     @id @default(cuid())
  email            String     @unique
  name             String?
  password         String?
  roleId           String
  avatarId         String?    @unique
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt
  lastSignInAt     DateTime?
  emailVerifiedAt  DateTime?
  status           UserStatus @default(ACTIVE)
  xp               Int        @default(0)
  streak           Int        @default(0)
  lastActiveAt     DateTime?  @default(now())
  gems             Int        @default(0)

  // Relations
  role           UserRole         @relation(fields: [roleId], references: [id], onDelete: Restrict)
  avatar         Image?           @relation(fields: [avatarId], references: [id])
  sessions       Session[]
  accounts       Account[]
  systemLog      SystemLog[]

  // Progress and achievements
  achievements   UserAchievement[]
  
  // Novas relações para múltiplos cursos
  enrollments    UserEnrollment[]
  
  // Subscription
  userSubscription UserSubscription?

  // Questionnaire
  questionnaire UserQuestionnaire?

  // Estatísticas gerais do usuário (mantidas de UserProgress)
  hearts           Int      @default(5)
  totalPoints      Int      @default(0)
  level            Int      @default(1)
  totalStudyTime   Int      @default(0) // em minutos
  dailyStudyTime   Int      @default(0)
  perfectExercises Int      @default(0)
  currentStreak    Int      @default(0)
  longestStreak    Int      @default(0)
  lastActivityAt   DateTime?

  @@map("users")
  challengeProgresses ChallengeProgress[]
}

// NOVO MODELO: Matrícula do usuário em cursos
model UserEnrollment {
  id               Int              @id @default(autoincrement())
  userId           String
  courseId         Int
  status           EnrollmentStatus @default(ACTIVE)
  isActive         Boolean          @default(false) // se é o curso ativo no momento
  progressPercent  Float            @default(0.0)
  
  // Progress tracking específico deste curso
  completedLessons   Int[] // IDs das lições completadas neste curso
  completedChallenges Int[] // IDs dos desafios completados neste curso
  currentUnitId    Int?    // Unidade atual do usuário neste curso
  currentLessonId  Int?    // Lição atual do usuário neste curso
  
  // Estatísticas específicas deste curso
  coursePoints     Int      @default(0)
  courseHearts     Int      @default(5)
  perfectChallenges Int     @default(0)
  totalTimeSpent   Int      @default(0) // minutos
  
  // Metadados
  enrolledAt       DateTime @default(now())
  startedAt        DateTime?
  completedAt      DateTime?
  lastAccessedAt   DateTime @default(now())
  
  // Relations
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  course           Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  currentUnit      Unit?    @relation("CurrentUnit", fields: [currentUnitId], references: [id])
  currentLesson    Lesson?  @relation("CurrentLesson", fields: [currentLessonId], references: [id])
  
  @@unique([userId, courseId])
  @@map("user_enrollments")
  
  @@index([userId, isActive])
  @@index([userId, lastAccessedAt])
  challengeProgresses ChallengeProgress[]
}

model Course {
  id             Int                @id @default(autoincrement())
  title          String
  imageSrc       String
  description    String?
  language       String? // Para cursos de idioma: "en", "es", etc.
  technology     String? // Para programação: "javascript", "python", etc.
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  category       CourseCategory
  level          CourseLevel
  estimatedHours Int // Duração total estimada
  isFeatured     Boolean            @default(false)
  isPublic       Boolean            @default(true)

  // Relations
  units          Unit[]
  enrollments    UserEnrollment[]   // Usuários matriculados
  questionnaires UserQuestionnaire[] // Questionários que recomendaram este curso

  @@map("courses")
}

model Unit {
  id             Int    @id @default(autoincrement())
  title          String
  description    String
  courseId       Int
  order          Int
  estimatedHours Int

  // Relations
  course  Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessons Lesson[]

  // Progress tracking
  totalExercises Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relação com UserEnrollment (unidade atual)
  currentEnrollments UserEnrollment[] @relation("CurrentUnit")

  @@map("units")
}

model Lesson {
  id               Int     @id @default(autoincrement())
  title            String
  unitId           Int
  order            Int
  description      String?
  content          String? @db.Text
  videoUrl         String?
  estimatedMinutes Int

  // Progress tracking
  totalExercises Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  unit       Unit        @relation(fields: [unitId], references: [id], onDelete: Cascade)
  challenges Challenge[]
  
  // Relação com UserEnrollment (lição atual)
  currentEnrollments UserEnrollment[] @relation("CurrentLesson")

  @@map("lessons")
}

model Challenge {
  id         Int             @id @default(autoincrement())
  lessonId   Int
  type       ChallengeType
  difficulty DifficultyLevel
  question   String
  order      Int

  // Relations
  lesson            Lesson              @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  challengeOptions  ChallengeOption[]
  challengeProgress ChallengeProgress[]

  @@map("challenges")
}

model ChallengeOption {
  id          Int     @id @default(autoincrement())
  challengeId Int
  text        String
  correct     Boolean
  imageSrc    String?
  audioSrc    String?
  codeSnippet String?
  explanation String?

  challenge Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)

  @@map("challenge_options")
}

model ChallengeProgress {
  id          Int       @id @default(autoincrement())
  userId      String
  challengeId Int
  enrollmentId Int      // A qual matrícula pertence este progresso
  completed   Boolean   @default(false)
  completedAt DateTime?
  score       Int?      // Pontuação no desafio (0-100)
  attempts    Int       @default(0)

  // Relations
  challenge  Challenge  @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  enrollment UserEnrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)

  @@unique([enrollmentId, challengeId]) // Um desafio por matrícula
  @@map("challenge_progress")
}

model UserSubscription {
  id                     Int      @id @default(autoincrement())
  userId                 String   @unique
  stripeCustomerId       String?   @unique
  stripeSubscriptionId   String?   @unique
  stripePriceId          String?
  stripeCurrentPeriodEnd DateTime?
  tier       SubscriptionTier @default(FREE)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_subscription")
}

model UserQuestionnaire {
  id                  Int         @id @default(autoincrement())
  userId              String      @unique
  discoverySource     String
  learningGoal        String
  languageLevel       String
  dailyGoal           String
  selectedCourseId    Int?
  selectedCourseTitle String?
  courseLevel         CourseLevel
  intensity           Intensity
  focus               Focus
  recommendedCourses  Int[]       // Array de course IDs recomendados

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  selectedCourse Course? @relation(fields: [selectedCourseId], references: [id], onDelete: Cascade)
  user           User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_questionnaire")
}

model UserRole {
  id          String  @id @default(cuid())
  name        String  @unique
  description String?
  users       User[]

  @@map("user_roles")
}

model Image {
  id        String    @id @default(uuid())
  url       String    @unique
  publicUrl String
  path      String    @unique
  sessionId String?
  expiresAt DateTime?
  userId    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User? @relation

  @@index([sessionId])
  @@index([userId])
  @@map("images")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model UserAchievement {
  id          String   @id @default(cuid())
  userId      String
  achievement String
  earnedAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_achievements")
}

model SystemLog {
  id          String   @id @default(uuid())
  userId      String
  createdAt   DateTime @default(now())
  entityId    String?
  entityType  String?
  event       String?
  description String?
  ipAddress   String?
  meta        String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}